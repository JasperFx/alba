<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <meta charset="utf-8">
        <meta name="generator" content="Bootply" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <title>Alba - Getting Started</title>
        <link href="/alba/content/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <link href="/alba/content/prism.css" rel="stylesheet" type="text/css" />
        <link href="/alba/content/theme.css" rel="stylesheet" type="text/css" />

        <link rel="apple-touch-icon" href="/bootstrap/img/apple-touch-icon.png">
        <link rel="apple-touch-icon" sizes="72x72" href="/bootstrap/img/apple-touch-icon-72x72.png">
        <link rel="apple-touch-icon" sizes="114x114" href="/bootstrap/img/apple-touch-icon-114x114.png">

        <link href="/alba/content/affix.css" rel="stylesheet" type="text/css" />
    </head>

    <body>

      <a href="https://github.com/jasperfx/Alba"><img style="z-index: 5000; position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/e7bbb0521b397edbd5fe43e7f760759336b5e05f/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"></a>

      <nav class="navbar navbar-default navbar-fixed-top" role="banner">
      <div class="container">
        <div class="navbar-header">
          <a href="/alba" class="navbar-brand">Alba</a>
        </div>
        <nav class="collapse navbar-collapse" role="navigation">
          <ul class="nav navbar-nav pull-right">
            <li>
              <a href="/alba/getting_started">Getting Started</a>
            </li>
            <li>
              <a href="/alba/documentation">Documentation</a>
            </li>
            <li>
              <a href="https://gitter.im/jasperfx/Alba?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge&amp;utm_content=badge"><img src="https://camo.githubusercontent.com/da2edb525cde1455a622c58c0effc3a90b9a181c/68747470733a2f2f6261646765732e6769747465722e696d2f4a6f696e253230436861742e737667" alt="Join the chat at https://gitter.im/jasperfx/Alba" data-canonical-src="https://badges.gitter.im/Join%20Chat.svg" style="max-width:100%;"></a>
            </li>
            <li><a href="/alba/" title="Alba">Previous</a></li>
            <li><a href="/alba/documentation" title="Documentation">Next</a></li>
          </ul>
          <div class="navbar-form navbar-left" role="search">
            <div class="form-group">
              <input id="search" type="search" class="form-control" placeholder="Search">
            </div>
          </div>

        </nav>

      </div>
    </nav>

    <div class="container">
      <nav class="navbar-inverse">
        <ol class="breadcrumb"><li><a href="/alba/">Alba</a></li><li class="active">Getting Started</li></ol>
      </nav>
    </div>

    <!--main-->
    <div class="container">
      <div class="row">
          <!--left-->
          <div class="col-md-3" id="leftCol">
            <h3>Alba 4.0.0</h3>
            <br />

            <ul class="nav nav-stacked affix" id="sidebar">
            </ul>

            <h3 class="no-margin">Next</h3><p><a href="/alba/documentation">Documentation</a></p>
            <h3 class="no-margin">Previous</h3><a href="/alba/">Alba</a></p>
          </div><!--/left-->

          <!--right-->
          <div class="col-md-9">
              <h1>Getting Started</h1>

              <hr />

              <div id="main-pane">
                <!--Title:Getting Started-->
<!--Url:getting_started-->
<div class="alert-info alert"><p><strong>Note!</strong>
As of 4.0+, Alba only supports netcoreapp3.1+ applications. We have dropped all support for any version of ASP.NET Core before 3.1. Use Alba 3.x if you still require 2.1 support.</p>
</div>
<p>Alba is a class library that you use in combination with unit testing tools like <a href="https://xunit.github.io">xUnit.Net</a> to author integration tests
against ASP.NET Core HTTP endpoints that actually exercises the full application stack by running HTTP requests through your ASP.NET system in memory. As of version 2.0, Alba uses the built in <a href="https://docs.microsoft.com/en-us/aspnet/core/test/integration-tests?view=aspnetcore-2.2">TestHost</a> internally
to greatly improve its compatibility with many quirks of the ASP.NET Core model.</p>
<h2 id="asp.net-core-3.1-5.0">ASP.NET Core 3.1 &amp; 5.0</h2>
<p>If you start a new ASP.NET Core project with <code>dotnet new webapi</code>, you'll get this code in your <code>Program</code> file:</p>
<pre><code class="language-csharp">&#xA;public class Program&#xA;{&#xA;    public static void Main(string[] args)&#xA;    {&#xA;        CreateHostBuilder(args).Build().Run();&#xA;    }&#xA;&#xA;    public static IHostBuilder CreateHostBuilder(string[] args) =&gt;&#xA;        Host.CreateDefaultBuilder(args)&#xA;            .ConfigureWebHostDefaults(webBuilder =&gt; webBuilder.UseStartup&lt;Startup&gt;());&#xA;}&#xA;</code></pre>
<p>To connect that to Alba, create a <code>SystemUnderTest</code> like this using the definition of your <code>IHostBuilder</code>:</p>
<pre><code class="language-csharp">&#xA;[Fact]&#xA;public async Task build_system_under_test_from_Program()    &#xA;{&#xA;    var hostBuilder = Program.CreateHostBuilder(Array.Empty&lt;string&gt;());&#xA;    // You can also call hostBuilder.ConfigureServices() here to further customize&#xA;    // your application, and that&#x27;s frequently valuable in testing scenarios&#xA;    &#xA;    using (var system = new SystemUnderTest(hostBuilder))&#xA;    {&#xA;        // You can use the IoC container for the SystemUnderTest&#xA;        var configuration &#xA;            = system.Services.GetRequiredService&lt;IConfiguration&gt;();&#xA;        &#xA;        await system.Scenario(s =&gt;&#xA;        {&#xA;            s.Get.Url(&quot;/&quot;);&#xA;            s.ContentShouldBe(&quot;Hello world.&quot;);&#xA;        });&#xA;    }&#xA;}&#xA;</code></pre>
<p>In reality though, you probably want to check out the <a href="/alba/documentation/xunit">Integrating Alba with xUnit.Net</a> to do it a little more efficiently.</p>
<h2 id="writing-your-first-specification">Writing your first specification</h2>
<p>For the purpose of this sample, let's say you generate a new web api project with the standard <code>dotnet new webapi</code> template. If you do that, you'll have this bootstrapping code in your <code>Program.Main()</code> method:</p>
<pre><code>public class Program
{
    public static void Main(string[] args)
    {
        CreateHostBuilder(args).Build().Run();
    }

    public static IHostBuilder CreateHostBuilder(string[] args) =&gt;
        Host.CreateDefaultBuilder(args)
            .ConfigureWebHostDefaults(webBuilder =&gt; webBuilder.UseStartup&lt;Startup&gt;());
}
</code></pre>
<p>In this default setup, your application is more or less defined by the <code>Startup</code> class and there are no other customizations to the <code>HostBuilder</code>.</p>
<p>Back in your test project, the easiest, and probably most common, usage of Alba is to send and verify JSON message bodies to <code>Controller</code> actions. To that end, let's say you have this very contrived controller and web models:</p>
<pre><code class="language-csharp">&#xA;public enum OperationType&#xA;{&#xA;    Add,&#xA;    Subtract,&#xA;    Multiply,&#xA;    Divide&#xA;}&#xA;&#xA;public class OperationRequest&#xA;{&#xA;    public OperationType Type { get; set; }&#xA;    public int One { get; set; }&#xA;    public int Two { get; set; }&#xA;}&#xA;&#xA;public class OperationResult&#xA;{&#xA;    public int Answer { get; set; }&#xA;    public string Method { get; set; }&#xA;}&#xA;&#xA;[ApiController]&#xA;[Route(&quot;[controller]&quot;)]&#xA;public class MathController : Controller&#xA;{&#xA;    [HttpGet(&quot;add/{one}/{two}&quot;)]&#xA;    public OperationResult Add(int one, int two)&#xA;    {&#xA;        return new OperationResult&#xA;        {&#xA;            Answer = one &#x2B; two&#xA;        };&#xA;    }&#xA;&#xA;    [HttpPut]&#xA;    public OperationResult Put([FromBody]OperationRequest request)&#xA;    {&#xA;        switch (request.Type)&#xA;        {&#xA;            case OperationType.Add:&#xA;                return new OperationResult{Answer = request.One &#x2B; request.Two, Method = &quot;PUT&quot;};&#xA;            &#xA;            case OperationType.Multiply:&#xA;                return new OperationResult{Answer = request.One * request.Two, Method = &quot;PUT&quot;};&#xA;            &#xA;            case OperationType.Subtract:&#xA;                return new OperationResult{Answer = request.One - request.Two, Method = &quot;PUT&quot;};&#xA;            &#xA;            default:&#xA;                throw new ArgumentOutOfRangeException(nameof(request.Type));&#xA;        }&#xA;    }&#xA;    &#xA;    [HttpPost]&#xA;    public OperationResult Post([FromBody]OperationRequest request)&#xA;    {&#xA;        switch (request.Type)&#xA;        {&#xA;            case OperationType.Add:&#xA;                return new OperationResult{Answer = request.One &#x2B; request.Two, Method = &quot;POST&quot;};&#xA;                &#xA;            case OperationType.Multiply:&#xA;                return new OperationResult{Answer = request.One * request.Two, Method = &quot;POST&quot;};&#xA;            &#xA;            case OperationType.Subtract:&#xA;                return new OperationResult{Answer = request.One - request.Two, Method = &quot;POST&quot;};&#xA;            &#xA;            default:&#xA;                throw new ArgumentOutOfRangeException(nameof(request.Type));&#xA;        }&#xA;    }&#xA;    &#xA;</code></pre>
<p>First off, let's test the GET method in that controller above by passing a url and verifying the results:</p>
<pre><code class="language-csharp">&#xA;[Fact]&#xA;public async Task get_happy_path()&#xA;{&#xA;    // SystemUnderTest is from Alba&#xA;    // The &quot;Startup&quot; type would be the Startup class from your&#xA;    // web application. &#xA;    using (var system = SystemUnderTest.ForStartup&lt;WebApp.Startup&gt;())&#xA;    {&#xA;        // Issue a request, and check the results&#xA;        var result = await system.GetAsJson&lt;OperationResult&gt;(&quot;/math/add/3/4&quot;);&#xA;        &#xA;        result.Answer.ShouldBe(7);&#xA;    }&#xA;}&#xA;</code></pre>
<p>So what just happened in that test? First off, the call to <code>SystemUnderTest.For&lt;T&gt;()</code> bootstraps your web application using the <code>Startup</code> type from your web application. Behind the scenes, Alba is using the same <code>Host.CreateDefaultBuilder().ConfigureWebHostDefaults(webBuilder =&gt; webBuilder.UseStartup&lt;T&gt;())</code> mechanism, but the difference is that Alba uses <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.testserver">TestServer</a> as a replacement for Kestrel (i.e., Alba does not spin up Kestrel during testing so there's no port conflicts). See <a href="/alba/documentation/bootstrapping">Bootstrapping and Configuration</a> for more information on advanced configuration options.</p>
<p>The call to <code>system.GetAsJson&lt;OperationResult&gt;(&quot;/math/add/3/4&quot;)</code> is performing these steps internally:</p>
<ol>
<li>Formulate an <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.httprequest?view=aspnetcore-5.0">HttpRequest</a> object that will be passed to the application</li>
<li>Execute the web request against your application, which will run all configured middleware and any MVC controller classes that match the requested url</li>
<li>Assert that the response status code is <code>200 OK</code></li>
<li>Read the raw JSON coming off the <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.httpresponse?view=aspnetcore-5.0">HttpResponse</a></li>
<li>Deserialize the raw JSON to the requested <code>OperationResult</code> type using the Json serialization settings of the running application</li>
<li>Returns the resulting <code>OperationResult</code></li>
</ol>
<p>Alright then, let's try posting JSON in and examining the JSON out:</p>
<pre><code class="language-csharp">&#xA;[Fact]&#xA;public async Task post_and_expect_response()&#xA;{&#xA;    using (var system = SystemUnderTest.ForStartup&lt;WebApp.Startup&gt;())&#xA;    {&#xA;        var request = new OperationRequest&#xA;        {&#xA;            Type = OperationType.Multiply,&#xA;            One = 3,&#xA;            Two = 4&#xA;        };&#xA;&#xA;        var result = await system.PostJson(request, &quot;/math&quot;)&#xA;            .Receive&lt;OperationResult&gt;();&#xA;        &#xA;        result.Answer.ShouldBe(12);&#xA;        result.Method.ShouldBe(&quot;POST&quot;);&#xA;    }&#xA;}&#xA;</code></pre>
<p>It's a little more complicated, but the same goal is realized here. Allow the test author to work in terms of the application model objects while still exercising the entire HTTP middleware stack.</p>
<p>Don't stop here though, Alba also gives you the ability to declaratively assert on elements of the <code>HttpResponse</code> like expected header values, status codes, and assertions against the response body. In addition, Alba provides a lot of helper facilities to work with the raw <code>HttpResponse</code> data.</p>
<h2 id="testing-hello-world">Testing Hello, World</h2>
<p>Now let's say that you built the obligatory hello world application for ASP.Net Core shown below:</p>
<pre><code class="language-csharp">&#xA;public class Startup&#xA;{&#xA;    public void Configure(IApplicationBuilder builder)&#xA;    {&#xA;        builder.Run(context =&gt;&#xA;        {&#xA;            context.Response.Headers[&quot;content-type&quot;] = &quot;text/plain&quot;;&#xA;            return context.Response.WriteAsync(&quot;Hello, World!&quot;);&#xA;        });&#xA;    }&#xA;}&#xA;</code></pre>
<p>We can now use Alba to declare an integration test for our Hello, World application within an <a href="http://xunit.github.io/">xUnit</a>
testing project:</p>
<pre><code class="language-csharp">&#xA;[Fact]&#xA;public async Task should_say_hello_world()&#xA;{&#xA;    using (var system = SystemUnderTest.ForStartup&lt;Startup&gt;())&#xA;    {&#xA;        // This runs an HTTP request and makes an assertion&#xA;        // about the expected content of the response&#xA;        await system.Scenario(_ =&gt;&#xA;        {&#xA;            _.Get.Url(&quot;/&quot;);&#xA;            _.ContentShouldBe(&quot;Hello, World!&quot;);&#xA;            _.StatusCodeShouldBeOk();&#xA;        });&#xA;    }&#xA;}&#xA;</code></pre>
<p>The sample up above bootstraps the application defined by our <code>Startup</code> and executes a <em>Scenario</em> against the running system.
A Scenario in Alba defines how the HTTP request should be constructed (the request body, headers, url) and optionally gives you
the ability to express assertions against the expected HTTP response.</p>
<p>Alba comes with plenty of helpers in its <a href="https://www.martinfowler.com/bliki/FluentInterface.html">fluent interface</a> to work with the <code>HttpRequest</code> and <code>HttpResponse</code>, or you can work directly with the underlying ASP.Net Core objects:</p>
<pre><code class="language-csharp">&#xA;[Fact]&#xA;public async Task should_say_hello_world_with_raw_objects()&#xA;{&#xA;    using (var system = SystemUnderTest.ForStartup&lt;Startup&gt;())&#xA;    {&#xA;        var response = await system.Scenario(_ =&gt;&#xA;        {&#xA;            _.Get.Url(&quot;/&quot;);&#xA;            _.StatusCodeShouldBeOk();&#xA;        });&#xA;&#xA;        response.ResponseBody.ReadAsText()&#xA;            .ShouldBe(&quot;Hello, World!&quot;);&#xA;&#xA;        // or you can go straight at the HttpContext&#xA;        // The ReadAllText() extension method is from Baseline&#xA;    }&#xA;}&#xA;</code></pre>
<p>Do note that Alba is not directly coupled to xUnit and would be usable within any .Net unit testing library.</p>
<p>To see where to go from here, see the <a href="/alba/documentation">Documentation</a></p>

              </div>

              <hr />

              <nav>
                <span>
                  <strong>Previous: </strong><a href="/alba/">Alba</a>

                </span>
                <span class="pull-right">

                  <strong>Next: </strong><a href="/alba/documentation">Documentation</a>

                </span>
              </nav>

          </div><!--/right-->
        </div><!--/row-->
      </div><!--/container-->

    </body>


    <footer>
        <script type='text/javascript' src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script type='text/javascript' src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

        <script type="text/javascript" src="/alba/content/prism.js"></script>
        <script type="text/javascript" src="/alba/content/sidebar.js"></script>
        <script type="text/javascript" src="/alba/content/affix.js"></script>

<script>
$('#search').keyup(function(e){
  if(e.keyCode == 13) {
    var search = $('#search').val();

    var url = 'https://www.google.com/#q=site:jasperfx.github.io ' + search;
    url = encodeURI(url);

    window.location.href = url;

    e.stopPropagation();
    if (e.cancelBubble!=null) e.cancelBubble = true;
    return false;
  }
});
</script>
    </footer>
</html>
